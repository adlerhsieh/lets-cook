<div id="layout" class="content pure-g">
  <div id="nav" class="pure-u-1">
    <a href="#" class="nav-menu-button">Menu</a>
    <div class="nav-inner">
      <div class="pure-menu pure-menu-open">
        <ul>
          <li><a href="#">搜尋食譜 <span class="email-count"></span></a></li>
          <li><a href="#">備忘清單</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="list" class="pure-u-1">
    <div class="email-item email-item-selected " id="search_block">
      <div class="pure-u-1" style="text-align:center">
        <form class="pure-form">
          <fieldset>
            <input id="search_input" type="text" placeholder="輸入食材..">
            <button class="pure-button pure-button-primary" id="search">搜尋</button>
          </fieldset>
        </form>
      </div>
    </div>
  </div>
  <div id="main" class="pure-u-1" style="width:95%">
    <button class="pure-button pure-button-success" style="right:20px;position:fixed">儲存</button>
    <div class="dishes">
      <% @dishes.each do |dish| %>

      <div>
        <div class=""><h1><%= dish.name %></h1></div>
        <div class="">
          <table class="pure-table pure-table-horizontal" style="width:100%">
            <thead>
              <tr>
                <th>#</th>
                <th>食材</th>
                <th>數量</th>
                <th>提供人</th>
                <th>我來提供</th>
              </tr>
            </thead>
            <tbody>
              <% ingredient_tmp_id = 1 %>
              <% dish.ingredients.each do |ingredient| %>
              <tr>
                <td><%= ingredient_tmp_id %></td>
                <td><%= ingredient.name %></td>
                <td><%= ingredient.amount %></td>
                <td><%= ingredient.preparer[0] ? ingredient.preparer[0].email : "None" %></td>
                <td><input id="" type="checkbox"></td>
                <% ingredient_tmp_id += 1 %>
              </tr>
              <% end %>
              <% ingredient_tmp_id = 1 %>
            </tbody>
          </table>
        </div>
      </div>

      <% end %>
    </div>
  </div>
</div>

<script src="http://yui.yahooapis.com/3.17.2/build/yui/yui-min.js"></script>

<script>
    YUI().use('node-base', 'node-event-delegate', function (Y) {

        var menuButton = Y.one('.nav-menu-button'),
            nav        = Y.one('#nav');

        // Setting the active class name expands the menu vertically on small screens.
        menuButton.on('click', function (e) {
            nav.toggleClass('active');
        });

        // Your application code goes here...

    });

    $(function(){
      $('#search').click(function(e){
        var search_input = $('#search_input').val();
        e.preventDefault();
        $.ajax({
          url:"/dishes/search.json",
          type: "POST",
          data:{"file": search_input},
          success:function(result){
            console.table(result);
            var search_block = $('#search_block');
            $('#list').empty();
            $('#list').append(search_block);
            for (var i = 0; i <= result.length - 1; i++) {
              $('#list').append(
                '<div class="email-item  pure-g"><div class="pure-u"><img id="'+result[i]['name']+'" class="email-avatar" alt="Tilo Mitra&#x27;s avatar" height="64" width="64" src="'+result[i]['lg_pic_link'] +'"></div><div class="pure-u-3-4"><h4 class="email-subject">'+result[i]['name']+'</h4><p class="email-desc"></p><button class="pure-button pure-button-success add-dish" id="'+result[i]['name']+'">加入</button></div></div><span id="link-'+result[i]['name']+'" style="display: none" class="'+result[i]['name']+'">'+result[i]["link"]+'</span>'
              );
            };
          },
          error: 
            function(){
              // alert("QQ");
              // alert('error');
            }
          });
        });
      $("#list").on("click",'.add-dish',function(){
        console.log($('h4.dish-name-'+$(this).data("child")).text());
        $.ajax({
          url: "/dishes",
          type: "POST",
          data: {
                 "dish": {
                   "user_id": "<%= current_user.id %>",
                   "event_id": "<%= @event.id %>",
                   "name": $(this).attr('id'),
                   "lg_pic_link": $('img#'+ $(this).attr('id')).attr("src"),
                   "link": $('span.'+ $(this).attr('id')).text()
                 }
                },
          success: function(result){
            console.log(result);
            var ingredient_lists = "";
            for (var i = 0; i <= result.ingredients.length - 1; i++) {
              ingredient_lists += '<tr><td>'+(i+1)+'</td><td>'+result.ingredients[i].name+'</td><td>'+result.ingredients[i].amount+'</td><td>None</td><td><input id="'+result.ingredients[i].id+'" type="checkbox"></td></tr>';
            };
            $('.dishes').append('<div><div class=""><h1>'+result.name+'</h1></div><div class=""><table class="pure-table pure-table-horizontal" style="width:100%"><thead><tr><th>#</th><th>食材</th><th>數量</th><th>提供人</th><th>我來提供</th></tr></thead><tbody>'+ingredient_lists+'</tbody></table></div></div>');
          }
        });
      });
    });
</script>
